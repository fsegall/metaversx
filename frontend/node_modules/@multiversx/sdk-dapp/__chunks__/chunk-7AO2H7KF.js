import{a as ve}from"./chunk-YTYNUTPN.js";import{a as ye}from"./chunk-QKFSKTYU.js";import{a as we}from"./chunk-HCNYEZXZ.js";import{a as H}from"./chunk-5C4GAWRH.js";import{a as me}from"./chunk-Q2AR5236.js";import{a as Le}from"./chunk-4ZTSYZ6M.js";import{a as fe}from"./chunk-7RDTBR37.js";import{a as Ce}from"./chunk-7JEFMDYF.js";import{a as pe}from"./chunk-WXDNXHED.js";import{b as y,f as de}from"./chunk-RFKFTNQQ.js";import{e as A,f as ge}from"./chunk-4JP4CKHO.js";import{c as ue,d as g}from"./chunk-KLQ5IZ6C.js";import{s as Me}from"./chunk-SFJMMIST.js";import{b as re,i as ie}from"./chunk-6BE2DPWP.js";import{e as ce,f as se,g as ae,h as le,o as be}from"./chunk-S55DZJQR.js";import{a as He}from"./chunk-MPMLX57E.js";import{a as O,c as Z,d as ee}from"./chunk-7UBLQIEN.js";import{c as ne}from"./chunk-6CPM3VCF.js";import{a as Oe}from"./chunk-Z3FCAX26.js";import{a as oe}from"./chunk-75SQ7UW4.js";import{b as Y,c as Ne}from"./chunk-6NZ6PUBT.js";import{a as te,b as je}from"./chunk-OWBHRN3S.js";import{p as De}from"./chunk-EOZJRV5E.js";import{j as u,m as X}from"./chunk-HBP5N4FR.js";X();import{useEffect as b,useRef as M,useState as L}from"react";Ne();Me();be();He();De();Oe();je();var Ge=(n=>(n.invalidAddress="Invalid address",n.invalidConfig="Invalid WalletConnect setup",n.invalidTopic="Expired connection",n.sessionExpired="Unable to connect to existing session",n.connectError="Unable to connect",n.userRejected="User rejected connection proposal",n.userRejectedExisting="User rejected existing connection proposal",n.errorLogout="Unable to remove existing pairing",n.invalidChainID="Invalid chainID",n))(Ge||{}),mn=({callbackRoute:h,token:G,nativeAuth:_,onLoginRedirect:he,logoutRoute:U,customRequestMethods:Te=[]})=>{var q;let T=ue(),E=we(_),p=me(E?_:!1),n=G,[F,a]=L(""),[I,Ee]=L(""),[B,f]=L(!0),[Ie,R]=L([]),[P,k]=L(null),{provider:D}=fe(),W=g(ce),S=g(se),V=g(ae),Pe=g(le),We=g(ie),Se=g(re),e=M(D),m=M(!1),v=M(!1),z=(q=U!=null?U:We)!=null?q:"/",x=[A.CANCEL_ACTION,...Te];G&&x.push(A.SIGN_LOGIN_TOKEN),E&&x.push(A.SIGN_NATIVE_AUTH_TOKEN);let Ve=B?"":`${Pe}?wallet-connect=${encodeURIComponent(I)}`,N=Boolean(F),j=H(),xe=()=>{Ce(z)},Ae=t=>{console.log("WalletConnect Session Event: ",t)},Ue=()=>u(void 0,null,function*(){var t,o,r,i;try{if(m.current||e.current==null)return;if(!v.current){try{yield(t=e.current)==null?void 0:t.logout()}catch(C){console.warn("Unable to logout")}return}let c=yield(r=(o=e.current)==null?void 0:o.getAddress)==null?void 0:r.call(o);if(!c){console.warn("Login cancelled.");return}let s=yield(i=e.current)==null?void 0:i.getSignature(),l={address:c,loginMethod:"walletconnectv2"},d={logoutRoute:z,loginType:"walletconnectv2",callbackRoute:h!=null?h:te().href};T(ne(d)),s&&p.setTokenLoginInfo({signature:s,address:c}),T(Y(l)),oe({callbackRoute:h,onLoginRedirect:he,options:{address:c,signature:s}})}catch(c){a("User rejected connection proposal"),console.error(c)}}),K=()=>u(void 0,null,function*(){var o,r,i,c,s;if(y(e.current)==="walletconnectv2")try{((c=(i=(r=(o=e.current)==null?void 0:o.walletConnector)==null?void 0:r.session)==null?void 0:i.getAll())!=null?c:[]).length>0&&(yield(s=e.current)==null?void 0:s.logout()),e.current=de,k(null)}catch(l){console.warn("Unable to logout")}}),Re=t=>u(void 0,null,function*(){var o,r,i;if(!W||!S){a("Invalid WalletConnect setup");return}if(!t||!t.topic){a("Expired connection");return}try{if((e.current?y(e.current):!1)!=="walletconnectv2"){yield w();return}if(f(!0),yield K(),E&&!n&&(n=yield p.getNativeAuthLoginToken(),!n)){console.warn("Fetching block failed. Login cancelled.");return}n&&p.setLoginToken(n),yield w(!1);let{approval:s}=yield(o=e.current)==null?void 0:o.connect({topic:t.topic,methods:x});try{yield(r=e.current)==null?void 0:r.login({approval:s,token:n})}catch(l){console.error("User rejected existing connection proposal",l),a("User rejected existing connection proposal"),f(!0),yield w()}}catch(c){console.error("Unable to connect to existing session",c),a("Unable to connect to existing session")}finally{R((i=e.current)==null?void 0:i.pairings)}}),ke=t=>u(void 0,null,function*(){var o,r;try{t&&(yield(o=e.current)==null?void 0:o.logout({topic:t}))}catch(i){console.error("Unable to remove existing pairing",i),a("Unable to remove existing pairing")}finally{let i=yield(r=e.current)==null?void 0:r.getPairings();R(i)}});function w(t=!0){return u(this,null,function*(){var C,J,Q;Le(),t&&(T(ee(O.address)),T(Z(O)));let o=yield ye({maxRetries:15});if(!o){console.error("Invalid chainID"),a("Invalid chainID");return}if(!S||!W){console.error("Invalid WalletConnect setup"),a("Invalid WalletConnect setup");return}let r=H(),i=v.current===!1&&!r,c=y(e.current)==="walletconnectv2",s=((J=(C=e.current)==null?void 0:C.isInitialized)==null?void 0:J.call(C))&&c;if(m.current||i||s)return;if(m.current=!0,(Q=e.current)!=null&&Q.walletConnector){yield e.current.init(),k(e.current),m.current=!1,t&&(yield $());return}let l={onClientLogin:Ue,onClientLogout:xe,onClientEvent:Ae},d=new ge(l,o,W,S,V);yield d.init(),k(d),e.current=d,m.current=!1,t&&(R(d.pairings),yield $())})}function $(){return u(this,null,function*(){var t,o;if(!!e.current){if(!W||!S){a("Invalid WalletConnect setup");return}try{if(!v.current)return;let{uri:r,approval:i}=yield(t=e.current)==null?void 0:t.connect({methods:x});if(!Boolean(r))return;if(Ee(r),(V==null?void 0:V.logger)==="debug"&&console.log("WalletConnect uri: ",r),E&&!n&&(n=yield p.getNativeAuthLoginToken(),!n)){console.warn("Fetching block failed. Login cancelled.");return}if(n&&p.setLoginToken(n),(e.current?y(e.current):!1)!=="walletconnectv2"){f(!0),yield w();return}try{yield(o=e.current)==null?void 0:o.login({approval:i,token:n})}catch(l){console.error("User rejected connection proposal",l),a("User rejected connection proposal"),f(!0)}}catch(r){console.error("Unable to connect",r)}}})}return ve(()=>{e.current=D},[D]),b(()=>(v.current=!0,()=>{v.current=!1}),[]),b(()=>{f(!I)},[I]),b(()=>{if(!P)return;(Boolean(P.session)||Se==="walletconnectv2")&&j&&pe(P)},[P,j]),[w,{error:F,loginFailed:N,isLoading:B&&!N,isLoggedIn:j&&!N},{uriDeepLink:Ve,walletConnectUri:I,cancelLogin:K,connectExisting:Re,removeExistingPairing:ke,wcPairings:Ie}]};export{Ge as a,mn as b};
//# sourceMappingURL=chunk-7AO2H7KF.js.map
